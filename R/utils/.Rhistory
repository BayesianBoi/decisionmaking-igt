model_dat_bis <- model_dat %>% select(matches("^bis_[0-9]+")) %>% select(noplan)
model_dat_stai <- model_dat %>% select(matches("^stai_[0-9]+")) %>% select(1:20)
m2 <- stan_model("~/Dropbox/Box/LAP/Impulsivety_Anxiety/Code/Stan/irt_mult_reg_estK_adaptPrior_normal_v2.stan")
data_list_m2 <- list(R1          = length(unique(unlist(c(model_dat_bis)))),
N_subjects1 = dim(model_dat_bis)[1],
N_items1    = dim(model_dat_bis)[2],
Y1          = model_dat_bis,
R2          = length(unique(unlist(c(model_dat_stai)))),
N_subjects2 = dim(model_dat_stai)[1],
N_items2    = dim(model_dat_stai)[2],
Y2          = model_dat_stai)
data_list_m2 <- append(data_list_m2, dataList)
set.seed(43201)
#fit_m2 <- vb(m2, data = data_list_m2, adapt_engaged = F, eta = .1)
fit_m2 <- sampling(m2, data = data_list_m2, iter = 4000, warmup = 1000, chains = 3, cores = 3)
traceplot(fit_m2)
traceplot(fit_m2, pars = paste0("c[", 1:10, "]"))
traceplot(fit_m2, pars = paste0("c[", 1:10, "]"), inc_warmup = T)
traceplot(fit_m2, pars = "mu_p", inc_warmup = T)
traceplot(fit_m2, pars = paste0("k[", 1:10, "]"), inc_warmup = T)
traceplot(fit_m2, pars = paste0("k[", 1:10, "]"), inc_warmup = F)
set.seed(43201)
fit_m2 <- sampling(m2, data = data_list_m2, iter = 2000, warmup = 500, chains = 20, cores = 20)
traceplot(fit_m2)
traceplot(fit_m2, pars = paste0("c[", 1:10, "]"), inc_warmup = F)
stan_plot(fit_m2, pars = paste0("c[", 1:10, "]"), show_density = T)
stan_plot(fit_m2, pars = paste0("k[", 1:10, "]"), show_density = T)
saveRDS(fit_m2, file = "~/Dropbox/Box/LAP/Impulsivity_Anxiety/Data/Fitted/irt_mult_reg_estK_adaptPrior_normal_v2_20chains.rds")
saveRDS(fit_m2, file = "~/Dropbox/Box/LAP/Impulsivety_Anxiety/Data/Fitted/irt_mult_reg_estK_adaptPrior_normal_v2_20chains.rds")
rm(list=ls())
rm(list=ls())
library(ggplot2)
library(cowplot)
library(dplyr)
library(doParallel)
library(foreach)
library(abind)
library(zoo)
library(pROC)
setwd("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/1_analysis/Simulation/simulate_igt_bayesian.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/set_version_igt.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/2_plotting/plot_IGT_dat.R")
# Run parameters
models <- c("orl_v7_4", "pvl_delta", "vpp")
iters  <- 100
cores  <- 15
# For original IGT
igt_versions <- c("original", "modified", "original", "modified", "original", "modified", "original", rep("modified", 3), rep("original", 2))
cl <- makeCluster(3)
registerDoParallel(cl)
results <- foreach(m=c(models), .combine = "rbind", .packages = c("doParallel", "foreach")) %dopar% {
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
all_sims <- foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# dims = [trials, deck, sims, subj]
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
subj_sims <- foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach")) %dopar% {
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],]
foreach(l=1:iters, .combine = "rbind") %do% {
# Confusion matrix
actual    <- factor(tmp_beh$deck, levels = 1:4)
predicted <- factor(tmp_pDeck[,1,l][1:length(tmp_beh$deck)], levels = 1:4)
# Metrics
cm <- caret::confusionMatrix(actual, predicted)$byClass
data.frame(Model        = m,
subjID       = j,
Deck         = 1:4,
iter         = l,
Bal_Accuracy = cm[,"Balanced Accuracy"], # same for each class
Sensitivity  = cm[,"Sensitivity"],
Specificity  = cm[,"Specificity"],
Precision    = cm[,"Precision"],
Recall       = cm[,"Recall"],
F1           = cm[,"F1"], row.names = NULL)
}
}
stopCluster(cl_in)
subj_sims
}
all_sims
}
stopCluster(cl)
m = models[1]
m = models[3]
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
all_sims <- foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# dims = [trials, deck, sims, subj]
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
subj_sims <- foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach")) %dopar% {
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],]
foreach(l=1:iters, .combine = "rbind") %do% {
# Confusion matrix
actual    <- factor(tmp_beh$deck, levels = 1:4)
predicted <- factor(tmp_pDeck[,1,l][1:length(tmp_beh$deck)], levels = 1:4)
# Metrics
cm <- caret::confusionMatrix(actual, predicted)$byClass
data.frame(Model        = m,
subjID       = j,
Deck         = 1:4,
iter         = l,
Bal_Accuracy = cm[,"Balanced Accuracy"], # same for each class
Sensitivity  = cm[,"Sensitivity"],
Specificity  = cm[,"Specificity"],
Precision    = cm[,"Precision"],
Recall       = cm[,"Recall"],
F1           = cm[,"F1"], row.names = NULL)
}
}
stopCluster(cl_in)
subj_sims
}
View(all_sims)
all_sims <- vpp_all_sims
vpp_all_sims <- all_sims
m = models[2]
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
all_sims <- foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# dims = [trials, deck, sims, subj]
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
subj_sims <- foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach")) %dopar% {
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],]
foreach(l=1:iters, .combine = "rbind") %do% {
# Confusion matrix
actual    <- factor(tmp_beh$deck, levels = 1:4)
predicted <- factor(tmp_pDeck[,1,l][1:length(tmp_beh$deck)], levels = 1:4)
# Metrics
cm <- caret::confusionMatrix(actual, predicted)$byClass
data.frame(Model        = m,
subjID       = j,
Deck         = 1:4,
iter         = l,
Bal_Accuracy = cm[,"Balanced Accuracy"], # same for each class
Sensitivity  = cm[,"Sensitivity"],
Specificity  = cm[,"Specificity"],
Precision    = cm[,"Precision"],
Recall       = cm[,"Recall"],
F1           = cm[,"F1"], row.names = NULL)
}
}
stopCluster(cl_in)
subj_sims
}
pvl_all_sims <- all_sims
m = models[1]
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
all_sims <- foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# dims = [trials, deck, sims, subj]
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
subj_sims <- foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach")) %dopar% {
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],]
foreach(l=1:iters, .combine = "rbind") %do% {
# Confusion matrix
actual    <- factor(tmp_beh$deck, levels = 1:4)
predicted <- factor(tmp_pDeck[,1,l][1:length(tmp_beh$deck)], levels = 1:4)
# Metrics
cm <- caret::confusionMatrix(actual, predicted)$byClass
data.frame(Model        = m,
subjID       = j,
Deck         = 1:4,
iter         = l,
Bal_Accuracy = cm[,"Balanced Accuracy"], # same for each class
Sensitivity  = cm[,"Sensitivity"],
Specificity  = cm[,"Specificity"],
Precision    = cm[,"Precision"],
Recall       = cm[,"Recall"],
F1           = cm[,"F1"], row.names = NULL)
}
}
stopCluster(cl_in)
subj_sims
}
orl_all_sims <- all_sims
all_sims <- rbind(orl_all_sims, pvl_all_sims, vpp_all_sims)
saveRDS(all_sims, file = "~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Simulated/all_sims_orl_pvl_vpp.rds")
rm(list=ls())
library(ggplot2)
library(cowplot)
library(dplyr)
library(doParallel)
library(foreach)
library(abind)
library(zoo)
library(pROC)
setwd("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/1_analysis/Simulation/simulate_igt_bayesian.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/set_version_igt.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/2_plotting/plot_IGT_dat.R")
# Run parameters
models <- c("orl_v7_4", "pvl_delta", "vpp")
iters  <- 100
cores  <- 15
# For original IGT
igt_versions <- c("original", "modified", "original", "modified", "original", "modified", "original", rep("modified", 3), rep("original", 2))
results <- foreach(m=c(models), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
all_sims <- foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# dims = [trials, deck, sims, subj]
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
subj_sims <- foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach")) %dopar% {
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],]
foreach(l=1:iters, .combine = "rbind") %do% {
# Confusion matrix
actual    <- factor(tmp_beh$deck, levels = 1:4)
predicted <- factor(tmp_pDeck[,1,l][1:length(tmp_beh$deck)], levels = 1:4)
# Metrics
cm <- caret::confusionMatrix(actual, predicted)$byClass
data.frame(Model        = m,
Study        = i,
subjID       = j,
Deck         = 1:4,
iter         = l,
Bal_Accuracy = cm[,"Balanced Accuracy"], # same for each class
Sensitivity  = cm[,"Sensitivity"],
Specificity  = cm[,"Specificity"],
Precision    = cm[,"Precision"],
Recall       = cm[,"Recall"],
F1           = cm[,"F1"], row.names = NULL)
}
}
stopCluster(cl_in)
subj_sims
}
all_sims
}
saveRDS(results, "~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Simulated/all_sims_orl_pvl_vpp.rds")
cm
caret::confusionMatrix(actual, predicted)$byClass
rm(list=ls())
library(ggplot2)
library(cowplot)
library(dplyr)
library(doParallel)
library(foreach)
library(abind)
library(zoo)
library(pROC)
setwd("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/1_analysis/Simulation/simulate_igt_bayesian.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/set_version_igt.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/2_plotting/plot_IGT_dat.R")
# Run parameters
models <- c("orl_v7_4", "pvl_delta", "vpp")
iters  <- 100
cores  <- 17
# For original IGT
igt_versions <- c("original", "modified", "original", "modified", "original", "modified", "original", rep("modified", 3), rep("original", 2))
# Iterating over models
results <- foreach(m=c(models), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
# Rename for later
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
# Iterating over datasets
foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# Simulation results
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
# Subset behavioral data
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
# Specify cluster for parallel
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
# Interating over subjects
foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach", "dplyr", "abind")) %dopar% {
# Curret subject chosen decks (recode)
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],] %>%
mutate(A = ifelse(deck==1, 1, 0),
B = ifelse(deck==2, 1, 0),
C = ifelse(deck==3, 1, 0),
D = ifelse(deck==4, 1, 0)) %>%
select(A, B, C, D)
# Iterating over simulations
acomb <- function(x, y) abind(x, y, along = 3)
sim_choices <- foreach(l=1:iters, .combine = "acomb") %do% {
# Simulated choices
val <- tmp_pDeck[,1,l][1:length(tmp_beh$A)]
data.frame(A = ifelse(val == 1, 1, 0),
B = ifelse(val == 2, 1, 0),
C = ifelse(val == 3, 1, 0),
D = ifelse(val == 4, 1, 0))
}
# Squared error
sim_avg <- apply(sim_choices, c(1,2), mean)
data.frame(Model  = m,
Study  = i,
subjID = j,
MSD    = sum((sim_avg - tmp_beh)^2) / 400)
}
stopCluster(cl_in)
}
}
results
data.frame(Model  = m,
Study  = i,
subjID = j,
MSD    = sum((sim_avg - tmp_beh)^2) / 400)
c(models)
models
rm(list=ls())
library(ggplot2)
library(cowplot)
library(dplyr)
library(doParallel)
library(foreach)
library(abind)
library(zoo)
library(pROC)
setwd("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/1_analysis/Simulation/simulate_igt_bayesian.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/utils/set_version_igt.R")
source("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/R/2_plotting/plot_IGT_dat.R")
# Run parameters
models <- c("orl_v7_4", "pvl_delta", "vpp")
iters  <- 100
cores  <- 17
# For original IGT
igt_versions <- c("original", "modified", "original", "modified", "original", "modified", "original", rep("modified", 3), rep("original", 2))
# Iterating over models
results <- foreach(m=c(models), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
behav_dat <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Preprocessed/all_dat_12_studies_IGT_Data_stan_ready.rds")
if (m=="orl_v7_2") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_2_4chains.rds")
} else if (m=="orl_v7_4") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_orl_v7_4_4chains_mod_final_fits.rds")
} else if (m=="pvl_delta") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_pvl_delta_v2_converged.rds")
} else if (m=="vpp") {
fits <- readRDS("~/Dropbox/Box/CCSL/Projects/IGT/manuscript/Code/Data/Fitted/fits_all_vpp_v3.rds")
}
# Rename for later
names(fits) <- unique(behav_dat$Study)
names(fits)[4] <- "Premkumar"
names(fits)[5] <- "SteingroverInPrep"
# Iterating over datasets
all_fits <- foreach(i=seq_along(names(fits)), .combine = "rbind", .packages = c("doParallel", "foreach")) %do% {
# Simulation results
all_pDeck <- simulate_igt(dat = fits[[names(fits)[i]]],
model = paste0(m,"_bayes"),
title = paste0(m,"_bayes"),
order = "set",
version = igt_versions[i],
iters = iters,
n_cores = cores,
pred_den = NULL)
# Subset behavioral data
avg <- behav_dat[behav_dat$Study == names(fits)[i],]
# Specify cluster for parallel
cl_in <- makeCluster(cores)
registerDoParallel(cl_in)
# Interating over subjects
foreach(j=seq_along(unique(avg$subjID)), .combine = "rbind", .packages = c("doParallel", "foreach", "dplyr", "abind")) %dopar% {
# Curret subject chosen decks (recode)
tmp_pDeck <- all_pDeck[,,,j]
tmp_beh <- avg[avg$subjID == unique(avg$subjID)[j],] %>%
mutate(A = ifelse(deck==1, 1, 0),
B = ifelse(deck==2, 1, 0),
C = ifelse(deck==3, 1, 0),
D = ifelse(deck==4, 1, 0)) %>%
select(A, B, C, D)
# Iterating over simulations
acomb <- function(x, y) abind(x, y, along = 3)
sim_choices <- foreach(l=1:iters, .combine = "acomb") %do% {
# Simulated choices
val <- tmp_pDeck[,1,l][1:length(tmp_beh$A)]
data.frame(A = ifelse(val == 1, 1, 0),
B = ifelse(val == 2, 1, 0),
C = ifelse(val == 3, 1, 0),
D = ifelse(val == 4, 1, 0))
}
# Squared error
sim_avg <- apply(sim_choices, c(1,2), mean)
data.frame(Model  = m,
Study  = i,
subjID = j,
MSD    = sum((sim_avg - tmp_beh)^2) / 400)
}
stopCluster(cl_in)
}
all_fits
}
